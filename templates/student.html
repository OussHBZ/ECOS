<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OSCE Chat Simulator - Interface √âtudiant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Navigation Tabs for Student -->
        <div class="student-nav-tabs">
            <button class="nav-tab active" onclick="showStudentTab('practice-tab')">Entra√Ænement Libre</button>
            <button class="nav-tab" onclick="showStudentTab('competition-tab')">Comp√©titions</button>
            <button class="nav-tab" onclick="showStudentTab('stats-tab')">Mes Statistiques</button>
        </div>

        <div class="student-interface">
            <h1>Interface √âtudiant</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <p>Bienvenue, <strong>{{ student_name }}</strong></p>
                </div>
                <div>
                    <a href="{{ url_for('auth.logout') }}" class="back-button">D√©connexion</a>
                </div>
            </div>

            <!-- Practice Tab (existing content updated) -->
            <div id="practice-tab" class="student-tab-content active">
                <div class="practice-container">
                    <div class="section-header">
                        <h2>Entra√Ænement Libre</h2>
                        <div class="search-container">
                            <input type="text" id="practice-stations-search" placeholder="Rechercher stations..." class="search-input">
                            <button onclick="searchPracticeStations()" class="search-btn">Rechercher</button>
                        </div>
                    </div>

                    <div class="practice-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="available-stations-count">{{ cases|length }}</div>
                            <div class="stat-label">Stations Disponibles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="my-attempts-count">-</div>
                            <div class="stat-label">Mes Tentatives</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="my-best-score">-</div>
                            <div class="stat-label">Meilleur Score</div>
                        </div>
                    </div>

                    <!-- Filter section -->
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="case-number-search">Recherche par num√©ro de cas :</label>
                            <input type="number" id="case-number-search" class="search-input" placeholder="Entrez un num√©ro de cas">
                        </div>
                        
                        <div class="form-group">
                            <label for="specialty-filter">Filtrer par sp√©cialit√© :</label>
                            <select id="specialty-filter" class="filter-select">
                                <option value="">Toutes les sp√©cialit√©s</option>
                                {% for specialty in specialties %}
                                <option value="{{ specialty }}">{{ specialty }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Cases display for practice -->
                    <div class="cases-display">
                        <h3>S√©lectionnez une station pour l'entra√Ænement :</h3>
                        <div id="practice-cases-grid" class="cases-grid">
                            {% if cases %}
                                {% for case in cases %}
                                <div class="case-card practice-case-card" 
                                     data-case="{{ case.case_number }}"
                                     data-specialty="{{ case.specialty }}">
                                    <h4>Station {{ case.case_number }}</h4>
                                    <p><span class="specialty-badge">{{ case.specialty }}</span></p>
                                    <div class="case-stats">
                                        <span class="attempts-count">0 tentatives</span>
                                        <span class="best-score">-</span>
                                    </div>
                                    <button class="select-case-btn" onclick="selectPracticeCase('{{ case.case_number }}')">
                                        Commencer
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p>Aucune station disponible. Demandez √† un enseignant d'ajouter des cas.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Competition Tab (NEW) -->
            <div id="competition-tab" class="student-tab-content">
                <div class="competition-container">
                    <div class="section-header">
                        <h2>Sessions de Comp√©tition</h2>
                        <button onclick="loadAvailableCompetitions()" class="refresh-button">üîÑ Actualiser</button>
                    </div>

                    <div class="competition-info-box">
                        <h3>üèÜ Comment fonctionnent les comp√©titions ?</h3>
                        <ul>
                            <li><strong>Inscription automatique :</strong> Vous √™tes inscrit(e) aux comp√©titions par votre enseignant</li>
                            <li><strong>Connexion :</strong> Connectez-vous √† la session avant l'heure de d√©but</li>
                            <li><strong>D√©marrage :</strong> La comp√©tition d√©marre automatiquement quand tous les participants sont connect√©s</li>
                            <li><strong>Stations al√©atoires :</strong> Vous recevez des stations diff√©rentes des autres participants</li>
                            <li><strong>Feedback imm√©diat :</strong> Recevez votre √©valuation apr√®s chaque station</li>
                            <li><strong>Classement final :</strong> D√©couvrez votre position dans le groupe √† la fin</li>
                        </ul>
                    </div>

                    <div id="available-competitions-container">
                        <!-- Available competitions will be loaded here -->
                        <div class="loading-placeholder">
                            <p>Chargement des comp√©titions...</p>
                        </div>
                    </div>

                    <!-- Competition Session Interface -->
                    <div id="competition-session-interface" class="competition-session hidden">
                        <div class="competition-header">
                            <h3 id="competition-session-name">Session de Comp√©tition</h3>
                            <div class="competition-status" id="competition-status">
                                <span class="status-indicator" id="status-indicator"></span>
                                <span id="status-text">En attente...</span>
                            </div>
                        </div>

                        <div class="competition-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="competition-progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                                <span id="progress-text">0/0 stations</span>
                            </div>
                        </div>

                        <!-- Waiting Room -->
                        <div id="waiting-room" class="waiting-room hidden">
                            <div class="waiting-content">
                                <h4>üïê Salle d'attente</h4>
                                <p>En attente que tous les participants se connectent...</p>
                                <div class="participants-status">
                                    <span id="logged-in-count">0</span> / <span id="total-participants">0</span> participants connect√©s
                                </div>
                                <div class="loading-animation">
                                    <div class="spinner"></div>
                                </div>
                                <p class="waiting-instruction">La comp√©tition d√©marrera automatiquement d√®s que tous les participants seront connect√©s.</p>
                            </div>
                        </div>

                        <!-- Station Interface -->
                        <div id="station-interface" class="station-interface hidden">
                            <div class="station-header">
                                <h4>Station <span id="current-station-number">1</span> / <span id="total-station-count">3</span></h4>
                                <div class="station-info">
                                    <span class="station-specialty" id="station-specialty">Sp√©cialit√©</span>
                                    <span class="station-timer" id="station-timer">10:00</span>
                                </div>
                            </div>

                            <div class="station-directives" id="station-directives">
                                <!-- Station directives will be shown here -->
                            </div>

                            <div class="chat-interface">
                                <!-- Chat interface for the station -->
                                <div id="competition-chat-messages" class="chat-messages"></div>
                                <div class="chat-input-container">
                                    <input type="text" id="competition-chat-input" placeholder="Tapez votre message ici..." onkeypress="handleCompetitionChatKeypress(event)">
                                    <button id="send-competition-message" class="send-button" onclick="sendCompetitionMessage()">Envoyer</button>
                                </div>
                                <div class="station-controls">
                                    <button id="view-competition-images" class="secondary-button" onclick="viewCompetitionImages()" style="display: none;">Voir les images</button>
                                    <button id="end-station" class="end-station-button" onclick="endCurrentStation()">Terminer la station</button>
                                </div>
                            </div>
                        </div>

                        <!-- Between Stations -->
                        <div id="between-stations" class="between-stations hidden">
                            <div class="feedback-container">
                                <h4>üìä Feedback Station <span id="completed-station-number">1</span></h4>
                                <div class="station-score">
                                    <span class="score-value" id="station-score">0%</span>
                                    <span class="score-label">Score obtenu</span>
                                </div>
                                <div class="feedback-details" id="feedback-details">
                                    <!-- Detailed feedback will be shown here -->
                                </div>
                                <div class="next-station-countdown">
                                    <p>Prochaine station dans <span id="countdown-timer">120</span> secondes</p>
                                    <button id="start-next-station" class="submit-button" disabled onclick="startNextStation()">D√©marrer la prochaine station</button>
                                </div>
                            </div>
                        </div>

                        <!-- Final Results -->
                        <div id="final-results" class="final-results hidden">
                            <div class="results-container">
                                <h4>üéâ Comp√©tition Termin√©e !</h4>
                                
                                <div class="final-score-card">
                                    <div class="final-score">
                                        <span class="score-value" id="final-average-score">0%</span>
                                        <span class="score-label">Score Moyen Final</span>
                                    </div>
                                    <div class="final-rank">
                                        <span class="rank-value" id="final-rank">-</span>
                                        <span class="rank-label">Position / <span id="total-competitors">0</span></span>
                                    </div>
                                </div>

                                <div class="final-stats">
                                    <div class="stat-item">
                                        <span class="stat-value" id="total-stations-completed">0</span>
                                        <span class="stat-label">Stations Compl√©t√©es</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value" id="total-score-earned">0</span>
                                        <span class="stat-label">Score Total</span>
                                    </div>
                                </div>

                                <div class="leaderboard-container">
                                    <h5>üèÜ Top 10</h5>
                                    <div id="final-leaderboard">
                                        <!-- Leaderboard will be shown here -->
                                    </div>
                                </div>

                                <div class="final-actions">
                                    <button onclick="returnToCompetitions()" class="submit-button">Retour aux Comp√©titions</button>
                                    <button onclick="downloadCompetitionReport()" class="secondary-button">T√©l√©charger Rapport</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Tab (updated) -->
            <div id="stats-tab" class="student-tab-content">
                <div class="stats-container">
                    <div class="section-header">
                        <h2>Mes Statistiques</h2>
                        <button onclick="loadStudentStats()" class="refresh-button">üîÑ Actualiser</button>
                    </div>

                    <div class="student-overview-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-workouts">-</div>
                            <div class="stat-label">Total Consultations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="unique-stations-played">-</div>
                            <div class="stat-label">Stations Uniques</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="overall-average-score">-</div>
                            <div class="stat-label">Score Moyen Global</div>
                        </div>
                    </div>

                    <div class="performance-table-container">
                        <h3>Performances R√©centes</h3>
                        <table class="performance-table" id="student-performance-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Station</th>
                                    <th>Sp√©cialit√©</th>
                                    <th>Score</th>
                                    <th>Note</th>
                                    <th>Statut</th>
                                    <th>Dur√©e</th>
                                </tr>
                            </thead>
                            <tbody id="student-performance-table-body">
                                <!-- Student performance data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Practice Chat Interface (existing functionality) -->
            <div id="practice-chat-container" class="chat-container hidden">
                <div class="chat-header">
                    <h2>Consultation en cours - <span id="current-case-title"></span></h2>
                    <div class="chat-header-controls">
                        <button id="view-directives-btn" class="view-button" onclick="viewDirectives()">Voir les directives</button>
                        <div class="timer-container">
                            <span id="timer">10:00</span>
                        </div>
                        <button id="end-chat" class="end-button" onclick="endPracticeChat()">Terminer la consultation</button>
                    </div>
                </div>
                <div id="chat-messages"></div>
                <div class="input-container">
                    <input type="text" id="user-input" placeholder="Tapez votre message..." onkeypress="handleChatKeypress(event)">
                    <button id="send-btn" onclick="sendMessage()">Envoyer</button>
                </div>
            </div>
            
            <!-- Directives Modal (existing) -->
            <div id="directives-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-modal directives-close" onclick="closeDirectivesModal()">&times;</span>
                    <h3>Directives pour cette consultation</h3>
                    <div id="directives-content" class="directives-content"></div>
                </div>
            </div>

            <!-- Images Modal -->
            <div id="images-modal" class="modal hidden">
                <div class="modal-content image-modal-content">
                    <span class="close-modal" onclick="closeImagesModal()">&times;</span>
                    <h3>Images m√©dicales</h3>
                    <div id="images-content" class="images-content"></div>
                </div>
            </div>
            
            <!-- Evaluation Container (existing) -->
            <div id="evaluation-container" class="evaluation-container hidden">
                <div class="evaluation-header">
                    <h2>√âvaluation de la consultation</h2>
                    <button id="back-to-practice" class="back-button" onclick="backToPractice()">Retour √† l'entra√Ænement</button>
                </div>
                <div class="evaluation-content">
                    <div id="evaluation-results"></div>
                    <div class="evaluation-actions">
                        <button id="download-evaluation" class="download-button" onclick="downloadEvaluation()">T√©l√©charger le rapport PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/student.js') }}"></script>
    <script>
        // Competition-specific JavaScript functions

        let competitionUpdateInterval = null;
        let stationTimer = null;
        let countdownTimer = null;
        let currentCompetitionId = null;
        let currentStationData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadStudentStats();
            loadAvailableCompetitions();
            
            // Set up filter event listeners
            document.getElementById('case-number-search').addEventListener('input', filterPracticeCases);
            document.getElementById('specialty-filter').addEventListener('change', filterPracticeCases);
        });

        // Tab switching function
        function showStudentTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.student-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.student-nav-tabs .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Load content for specific tabs
            if (tabName === 'practice-tab') {
                loadPracticeData();
            } else if (tabName === 'competition-tab') {
                loadAvailableCompetitions();
            } else if (tabName === 'stats-tab') {
                loadStudentStats();
            }
            
            // Stop competition polling if leaving competition tab
            if (tabName !== 'competition-tab') {
                stopCompetitionPolling();
            }
        }

        // Load practice data
        function loadPracticeData() {
            // This function can be expanded to load practice-specific data
            console.log('Loading practice data...');
        }

        // Filter practice cases
        function filterPracticeCases() {
            const caseNumber = document.getElementById('case-number-search').value;
            const specialty = document.getElementById('specialty-filter').value;
            
            const cases = document.querySelectorAll('.practice-case-card');
            cases.forEach(caseCard => {
                const cardCaseNumber = caseCard.dataset.case;
                const cardSpecialty = caseCard.dataset.specialty;
                
                const matchesNumber = !caseNumber || cardCaseNumber.includes(caseNumber);
                const matchesSpecialty = !specialty || cardSpecialty === specialty;
                
                if (matchesNumber && matchesSpecialty) {
                    caseCard.style.display = 'block';
                } else {
                    caseCard.style.display = 'none';
                }
            });
        }

        // Select practice case
        function selectPracticeCase(caseNumber) {
            startPracticeConsultation(caseNumber);
        }

        // Start practice consultation
        async function startPracticeConsultation(caseNumber) {
            try {
                const response = await fetch('/initialize_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        case_number: caseNumber
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Hide practice interface
                    document.getElementById('practice-tab').classList.add('hidden');
                    
                    // Show chat interface
                    document.getElementById('practice-chat-container').classList.remove('hidden');
                    document.getElementById('current-case-title').textContent = `Station ${caseNumber}`;
                    
                    // Set up timer
                    startPracticeTimer(data.consultation_time || 10);
                    
                    // Store directives
                    if (data.directives) {
                        document.getElementById('directives-content').innerHTML = 
                            data.directives.replace(/\n/g, '<br>');
                    }
                    
                    console.log('Practice consultation started for case:', caseNumber);
                } else {
                    throw new Error('Failed to start consultation');
                }
            } catch (error) {
                console.error('Error starting practice consultation:', error);
                showError('Erreur lors du d√©marrage de la consultation');
            }
        }

        // Load available competitions
        async function loadAvailableCompetitions() {
            try {
                const response = await fetch('/student/available-competitions');
                if (!response.ok) throw new Error('Failed to load competitions');
                
                const data = await response.json();
                displayAvailableCompetitions(data.competitions);
                
            } catch (error) {
                console.error('Error loading competitions:', error);
                showError('Erreur lors du chargement des comp√©titions');
            }
        }

        // Display available competitions
        function displayAvailableCompetitions(competitions) {
            const container = document.getElementById('available-competitions-container');
            
            if (competitions.length === 0) {
                container.innerHTML = `
                    <div class="no-competitions">
                        <h3>Aucune comp√©tition disponible</h3>
                        <p>Vous n'√™tes inscrit(e) √† aucune comp√©tition pour le moment.</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="competitions-grid">';
            
            competitions.forEach(competition => {
                const canJoin = competition.can_join && competition.student_status === 'registered';
                const canContinue = competition.can_continue && ['logged_in', 'active', 'between_stations'].includes(competition.student_status);
                
                html += `
                    <div class="competition-card ${competition.status}">
                        <div class="competition-header">
                            <h3>${competition.name}</h3>
                            <span class="competition-status-badge status-${competition.status}">${competition.status_display}</span>
                        </div>
                        
                        <div class="competition-info">
                            <p><strong>D√©but:</strong> ${competition.start_time}</p>
                            <p><strong>Fin:</strong> ${competition.end_time}</p>
                            <p><strong>Stations:</strong> ${competition.stations_per_session} stations de ${competition.time_per_station} min</p>
                            <p><strong>Participants:</strong> ${competition.logged_in_count}/${competition.participant_count} connect√©s</p>
                        </div>

                        <div class="student-progress">
                            <p><strong>Mon statut:</strong> ${getStudentStatusDisplay(competition.student_status)}</p>
                            ${competition.progress > 0 ? `<p><strong>Progr√®s:</strong> ${competition.progress}%</p>` : ''}
                        </div>

                        <div class="competition-actions">
                            ${canJoin ? `<button onclick="joinCompetition(${competition.id})" class="submit-button">Rejoindre</button>` : ''}
                            ${canContinue ? `<button onclick="continueCompetition(${competition.id})" class="submit-button">Continuer</button>` : ''}
                            ${competition.status === 'completed' ? `<button onclick="viewCompetitionResults(${competition.id})" class="secondary-button">Voir R√©sultats</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Join competition
        async function joinCompetition(sessionId) {
            try {
                const response = await fetch(`/student/join-competition/${sessionId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentCompetitionId = sessionId;
                    
                    if (result.waiting_for_others) {
                        showWaitingRoom(sessionId);
                    } else {
                        startCompetitionSession(sessionId);
                    }
                } else {
                    showError(result.error || 'Erreur lors de la connexion');
                }
                
            } catch (error) {
                console.error('Error joining competition:', error);
                showError('Erreur lors de la connexion √† la comp√©tition');
            }
        }

        // Continue competition
        async function continueCompetition(sessionId) {
            currentCompetitionId = sessionId;
            await updateCompetitionStatus(sessionId);
        }

        // Show waiting room
        function showWaitingRoom(sessionId) {
            hideAllCompetitionScreens();
            document.getElementById('competition-session-interface').classList.remove('hidden');
            document.getElementById('waiting-room').classList.remove('hidden');
            
            // Start polling for status updates
            startCompetitionPolling(sessionId);
        }

        // Start competition session
        function startCompetitionSession(sessionId) {
            hideAllCompetitionScreens();
            document.getElementById('competition-session-interface').classList.remove('hidden');
            
            // Start status updates
            startCompetitionPolling(sessionId);
        }

        // Hide all competition screens
        function hideAllCompetitionScreens() {
            const screens = ['waiting-room', 'station-interface', 'between-stations', 'final-results'];
            screens.forEach(screenId => {
                document.getElementById(screenId).classList.add('hidden');
            });
        }

        // Start competition status polling
        function startCompetitionPolling(sessionId) {
            if (competitionUpdateInterval) {
                clearInterval(competitionUpdateInterval);
            }
            
            competitionUpdateInterval = setInterval(() => {
                updateCompetitionStatus(sessionId);
            }, 2000); // Update every 2 seconds
        }

        // Update competition status
        async function updateCompetitionStatus(sessionId) {
            try {
                const response = await fetch(`/student/competition/${sessionId}/status`);
                if (!response.ok) throw new Error('Failed to get status');
                
                const status = await response.json();
                updateCompetitionInterface(status);
                
            } catch (error) {
                console.error('Error updating competition status:', error);
            }
        }

        // Update competition interface based on status
        function updateCompetitionInterface(status) {
            // Update session name and progress
            document.getElementById('competition-session-name').textContent = status.session_name;
            
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = `${status.progress_percentage}%`;
            progressText.textContent = `${status.completed_stations}/${status.total_stations} stations`;

            // Handle different student states
            switch (status.student_status) {
                case 'logged_in':
                    showWaitingState();
                    break;
                case 'active':
                    if (status.current_station) {
                        showStationInterface(status.current_station, status.time_per_station, status.total_stations);
                    }
                    break;
                case 'between_stations':
                    showBetweenStations(status.time_between_stations);
                    break;
                case 'completed':
                    showFinalResults(status);
                    stopCompetitionPolling();
                    break;
            }
        }

        // Show waiting state
        function showWaitingState() {
            hideAllCompetitionScreens();
            document.getElementById('waiting-room').classList.remove('hidden');
        }

        // Show station interface
        function showStationInterface(station, timePerStation, totalStations) {
            hideAllCompetitionScreens();
            document.getElementById('station-interface').classList.remove('hidden');
            
            // Update station info
            document.getElementById('current-station-number').textContent = station.station_order;
            document.getElementById('total-station-count').textContent = totalStations;
            document.getElementById('station-specialty').textContent = station.specialty;
            
            // Start station timer
            startStationTimer(timePerStation * 60); // Convert to seconds
            
            // Initialize chat if not already done
            if (!currentStationData || currentStationData.case_number !== station.case_number) {
                currentStationData = station;
                initializeCompetitionStationChat(station.case_number);
            }
        }

        // Initialize competition station chat
        async function initializeCompetitionStationChat(caseNumber) {
            try {
                const response = await fetch(`/student/competition/${currentCompetitionId}/start-station`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Display directives
                    if (data.directives) {
                        document.getElementById('station-directives').innerHTML = 
                            `<p><strong>Instructions:</strong> ${data.directives.replace(/\n/g, '<br>')}</p>`;
                    }
                    
                    // Clear chat messages
                    document.getElementById('competition-chat-messages').innerHTML = '';
                    
                    console.log('Competition station initialized:', data);
                } else {
                    throw new Error('Failed to start station');
                }
            } catch (error) {
                console.error('Error initializing station:', error);
                showError('Erreur lors de l\'initialisation de la station');
            }
        }

        // Send competition message
        async function sendCompetitionMessage() {
            const input = document.getElementById('competition-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToCompetitionChat('user', message);
            input.value = '';
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addMessageToCompetitionChat('ai', data.reply);
                } else {
                    throw new Error('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToCompetitionChat('system', 'Erreur lors de l\'envoi du message');
            }
        }

        // Add message to competition chat
        function addMessageToCompetitionChat(sender, message) {
            const chatMessages = document.getElementById('competition-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>Vous:</strong> ${message}`;
            } else if (sender === 'ai') {
                messageDiv.innerHTML = `<strong>Patient:</strong> ${message}`;
                
                // Check for images in the message
                if (message.includes('/static/images/')) {
                    document.getElementById('view-competition-images').style.display = 'inline-block';
                }
            } else {
                messageDiv.innerHTML = message;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle competition chat keypress
        function handleCompetitionChatKeypress(event) {
            if (event.key === 'Enter') {
                sendCompetitionMessage();
            }
        }

        // End current station
        async function endCurrentStation() {
            try {
                const response = await fetch('/student/competition/complete-station', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        showStationFeedback(result);
                    } else {
                        throw new Error('Failed to complete station');
                    }
                } else {
                    throw new Error('Failed to complete station');
                }
            } catch (error) {
                console.error('Error ending station:', error);
                showError('Erreur lors de la finalisation de la station');
            }
        }

        // Show station feedback
        function showStationFeedback(result) {
            hideAllCompetitionScreens();
            document.getElementById('between-stations').classList.remove('hidden');
            
            // Update feedback display
            document.getElementById('completed-station-number').textContent = result.current_station;
            document.getElementById('station-score').textContent = `${result.evaluation.percentage || 0}%`;
            
            // Display detailed feedback
            const feedbackDetails = document.getElementById('feedback-details');
            let feedbackHTML = '<h5>D√©tails de l\'√©valuation:</h5>';
            
            if (result.evaluation.checklist) {
                feedbackHTML += '<ul>';
                result.evaluation.checklist.forEach(item => {
                    const status = item.completed ? '‚úÖ' : '‚ùå';
                    feedbackHTML += `<li>${status} ${item.description} (${item.points} pts)</li>`;
                });
                feedbackHTML += '</ul>';
            }
            
            if (result.recommendations && result.recommendations.length > 0) {
                feedbackHTML += '<h6>Recommandations:</h6><ul>';
                result.recommendations.forEach(rec => {
                    feedbackHTML += `<li>${rec}</li>`;
                });
                feedbackHTML += '</ul>';
            }
            
            feedbackDetails.innerHTML = feedbackHTML;
            
            // If not finished, start countdown
            if (!result.is_finished) {
                startCountdownTimer(result.next_station_delay || 120);
            } else {
                // Show final results
                setTimeout(() => {
                    showFinalResults(result);
                }, 3000);
            }
        }

        // Show between stations screen
        function showBetweenStations(timeBetween) {
            hideAllCompetitionScreens();
            document.getElementById('between-stations').classList.remove('hidden');
            
            // Start countdown timer
            startCountdownTimer(timeBetween * 60); // Convert to seconds
        }

        // Start next station
        async function startNextStation() {
            // This will be handled by the polling system
            document.getElementById('start-next-station').disabled = true;
            document.getElementById('start-next-station').textContent = 'Pr√©paration...';
        }

        // Show final results
        function showFinalResults(result) {
            hideAllCompetitionScreens();
            document.getElementById('final-results').classList.remove('hidden');
            
            // Update final scores and ranking
            if (result.final_score !== undefined) {
                document.getElementById('final-average-score').textContent = `${result.final_score}%`;
            }
            
            if (result.rank !== undefined) {
                document.getElementById('final-rank').textContent = result.rank;
                document.getElementById('total-competitors').textContent = result.total_participants || 0;
            }
            
            if (result.total_stations !== undefined) {
                document.getElementById('total-stations-completed').textContent = result.total_stations;
            }
            
            if (result.total_score !== undefined) {
                document.getElementById('total-score-earned').textContent = result.total_score;
            }
            
            // Display leaderboard
            if (result.leaderboard) {
                displayFinalLeaderboard(result.leaderboard);
            }
        }

        // Display final leaderboard
        function displayFinalLeaderboard(leaderboard) {
            const container = document.getElementById('final-leaderboard');
            
            let html = '<table class="leaderboard-table"><thead><tr>';
            html += '<th>Rang</th><th>√âtudiant</th><th>Score Moyen</th></tr></thead><tbody>';
            
            leaderboard.forEach(entry => {
                html += `<tr>
                    <td>${entry.rank}</td>
                    <td>${entry.student_name}</td>
                    <td>${entry.average_score}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Start station timer
        function startStationTimer(seconds) {
            if (stationTimer) clearInterval(stationTimer);
            
            let timeLeft = seconds;
            const timerElement = document.getElementById('station-timer');
            
            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
                
                // Change color when time is running out
                if (timeLeft <= 60) {
                    timerElement.style.background = '#FFCDD2';
                    timerElement.style.color = '#D32F2F';
                } else if (timeLeft <= 180) {
                    timerElement.style.background = '#FFF3E0';
                    timerElement.style.color = '#F57C00';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(stationTimer);
                    // Auto-end station
                    endCurrentStation();
                }
                timeLeft--;
            }
            
            updateTimer();
            stationTimer = setInterval(updateTimer, 1000);
        }

        // Start countdown timer
        function startCountdownTimer(seconds) {
            if (countdownTimer) clearInterval(countdownTimer);
            
            let timeLeft = seconds;
            const countdownElement = document.getElementById('countdown-timer');
            const startButton = document.getElementById('start-next-station');
            
            function updateCountdown() {
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    startButton.disabled = false;
                    startButton.textContent = 'D√©marrer la prochaine station';
                }
                timeLeft--;
            }
            
            updateCountdown();
            countdownTimer = setInterval(updateCountdown, 1000);
        }

        // Stop competition polling
        function stopCompetitionPolling() {
            if (competitionUpdateInterval) {
                clearInterval(competitionUpdateInterval);
                competitionUpdateInterval = null;
            }
            if (stationTimer) {
                clearInterval(stationTimer);
                stationTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        }

        // Helper functions
        function getStudentStatusDisplay(status) {
            const statusMap = {
                'registered': 'Inscrit',
                'logged_in': 'Connect√©',
                'active': 'En cours',
                'between_stations': 'Entre stations',
                'completed': 'Termin√©'
            };
            return statusMap[status] || status;
        }

        function showError(message) {
            alert(message); // Replace with a better error display system
        }

        function returnToCompetitions() {
            stopCompetitionPolling();
            hideAllCompetitionScreens();
            currentCompetitionId = null;
            currentStationData = null;
            loadAvailableCompetitions();
        }

        function downloadCompetitionReport() {
            // Implement download functionality
            console.log('Download competition report');
        }

        function viewCompetitionImages() {
            // Implement image viewing functionality
            console.log('View competition images');
        }

        // Practice-specific functions
        function startPracticeTimer(minutes) {
            let timeLeft = minutes * 60;
            const timerElement = document.getElementById('timer');
            
            function updatePracticeTimer() {
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(window.practiceTimerInterval);
                    endPracticeChat();
                }
                timeLeft--;
            }
            
            updatePracticeTimer();
            window.practiceTimerInterval = setInterval(updatePracticeTimer, 1000);
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            // Implement practice message sending
            console.log('Send practice message');
        }

        function endPracticeChat() {
            // Implement practice chat ending
            console.log('End practice chat');
        }

        function viewDirectives() {
            document.getElementById('directives-modal').classList.remove('hidden');
        }

        function closeDirectivesModal() {
            document.getElementById('directives-modal').classList.add('hidden');
        }

        function closeImagesModal() {
            document.getElementById('images-modal').classList.add('hidden');
        }

        function backToPractice() {
            document.getElementById('evaluation-container').classList.add('hidden');
            document.getElementById('practice-tab').classList.remove('hidden');
            document.getElementById('practice-chat-container').classList.add('hidden');
        }

        function downloadEvaluation() {
            // Implement evaluation download
            console.log('Download evaluation');
        }

        // Load student stats
        async function loadStudentStats() {
            try {
                const response = await fetch('/student/stats');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update overview stats
                    document.getElementById('total-workouts').textContent = data.total_workouts;
                    document.getElementById('unique-stations-played').textContent = data.unique_stations;
                    document.getElementById('overall-average-score').textContent = data.average_score + '%';
                    
                    // Update performance table
                    const tableBody = document.getElementById('student-performance-table-body');
                    tableBody.innerHTML = '';
                    
                    if (data.recent_performances && data.recent_performances.length > 0) {
                        data.recent_performances.forEach(perf => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${perf.completed_at}</td>
                                <td>${perf.case_number}</td>
                                <td>${perf.specialty}</td>
                                <td><span class="score-badge score-${getScoreClass(perf.score)}">${perf.score}%</span></td>
                                <td><span class="grade-badge grade-${perf.grade}">${perf.grade}</span></td>
                                <td><span class="status-badge status-${perf.status.toLowerCase().replace(' ', '-')}">${perf.status}</span></td>
                                <td>${perf.duration}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Aucune performance enregistr√©e</td></tr>';
                    }
                    
                    // Update practice stats
                    document.getElementById('my-attempts-count').textContent = data.total_workouts;
                    document.getElementById('my-best-score').textContent = data.average_score + '%';
                }
            } catch (error) {
                console.error('Error loading student stats:', error);
            }
        }

        function getScoreClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 80) return 'good';
            if (score >= 70) return 'average';
            if (score >= 60) return 'below-average';
            return 'poor';
        }

        // View competition results
        async function viewCompetitionResults(sessionId) {
            try {
                const response = await fetch(`/student/competition/${sessionId}/leaderboard`);
                if (response.ok) {
                    const data = await response.json();
                    // Display results in a modal or redirect to results page
                    console.log('Competition results:', data);
                }
            } catch (error) {
                console.error('Error loading competition results:', error);
            }
        }
    </script>
</body>
</html>